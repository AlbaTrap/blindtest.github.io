<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>YOLO Web App</title>
  <style>
    body { font-family: sans-serif; margin: 0; padding: 0; display: flex; flex-direction: column; align-items: center; }
    #container { position: relative; width: 640px; }
    video, canvas { width: 640px; height: 480px; }
    #overlay { position: absolute; left: 0; top: 0; }
    #status { margin: 10px; }
    #controls { margin: 10px; display: flex; gap: 10px; }
  </style>
</head>
<body>
  <h3>YOLO Web App</h3>
  <div id="controls">
    <input id="wsUrl" type="text" size="40" placeholder="http://192.168.0.166:8000/detect" />
    <button id="connectBtn">Connect</button>
    <button id="disconnectBtn">Disconnect</button>
    <label>Interval (ms): <input id="interval" type="number" value="200" /></label>
    <label>TTS every (s): <input id="ttsInterval" type="number" value="3" /></label>
  </div>

  <div id="container">
    <video id="video" autoplay playsinline muted></video>
    <canvas id="canvas" width="640" height="480" style="display:none;"></canvas>
    <canvas id="overlay" width="640" height="480"></canvas>
  </div>

  <div id="status">Disconnected</div>

<script>
  const video = document.getElementById('video');
  const canvas = document.getElementById('canvas');
  const overlay = document.getElementById('overlay');
  const ctx = canvas.getContext('2d');
  const octx = overlay.getContext('2d');
  const statusEl = document.getElementById('status');
  const intervalInput = document.getElementById('interval');
  const ttsIntervalInput = document.getElementById('ttsInterval');

  let timer = null;
  let lastTtsTime = 0;
  let serverUrl = "http://192.168.0.166:8000/detect"; 

  async function startCamera() {
    try {
      const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' }, audio: false });
      video.srcObject = stream;
      await video.play();
      console.log("Camera started:", video.videoWidth, "x", video.videoHeight);
    } catch (err) {
      console.error("Camera error:", err);
      alert('Nie udało się uruchomić kamery: ' + err.message);
    }
  }

  function drawDetections(detections) {
    octx.clearRect(0, 0, overlay.width, overlay.height);
    detections.forEach(det => {
      const [x1, y1, x2, y2] = det.bbox;
      octx.strokeStyle = 'magenta';
      octx.lineWidth = 2;
      octx.strokeRect(x1, y1, x2 - x1, y2 - y1);
      octx.fillStyle = 'rgba(0,0,0,0.6)';
      octx.fillRect(x1, y1 - 20, 180, 20);
      octx.fillStyle = 'white';
      octx.font = '14px sans-serif';
      const label = `${det.class} (${det.position}) ${det.confidence}`;
      octx.fillText(label, x1 + 4, y1 - 6);
    });
  }

  function speakPhrase(text) {
    const utter = new SpeechSynthesisUtterance(text);
    utter.rate = 1.0;
    speechSynthesis.speak(utter);
  }

  function speakDetections(detections) {
    const now = Date.now();
    const ttsIntervalMs = Number(ttsIntervalInput.value) * 1000;
    if (now - lastTtsTime < ttsIntervalMs) return;
    lastTtsTime = now;

    const phrases = detections.slice(0, 3).map(d => `${d.class} ${d.position}`);
    if (phrases.length > 0) {
      console.log("Speaking:", phrases.join(', '));
      speakPhrase(phrases.join(', '));
    }
  }

  async function sendFrameHttp() {
    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
    const dataUrl = canvas.toDataURL('image/jpeg', 0.6);

    console.log("Sending frame to:", serverUrl);
    try {
      const response = await fetch(serverUrl, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ image: dataUrl })
      });
      console.log("Response status:", response.status);
      const data = await response.json();
      console.log("Server response:", data);

      if (data.error) {
        console.warn("Server error:", data.error);
        return;
      }
      drawDetections(data.detections || []);
      speakDetections(data.detections || []);
    } catch (err) {
      console.error("HTTP error:", err);
    }
  }

  document.getElementById('connectBtn').onclick = async () => {
    const iv = Number(intervalInput.value) || 200;
    try {
      console.log("Testing connection to:", serverUrl);
      const testResp = await fetch(serverUrl, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ image: "" })
      });

      if (testResp.ok) {
        const testData = await testResp.json();
        console.log("Test response:", testData);
        statusEl.textContent = "Connected";
        console.log("Backend reachable, starting interval:", iv, "ms");
        timer = setInterval(sendFrameHttp, iv);
      } else {
        statusEl.textContent = "Connection failed";
        console.error("Backend not reachable, status:", testResp.status);
      }
    } catch (err) {
      statusEl.textContent = "Connection failed";
      console.error("Error connecting to backend:", err);
    }
  };

  document.getElementById('disconnectBtn').onclick = () => {
    statusEl.textContent = "Disconnected";
    if (timer) { clearInterval(timer); timer = null; }
    console.log("Disconnected, interval cleared");
  };

  startCamera();
</script>
</body>
</html>
